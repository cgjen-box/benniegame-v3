---
phase: 03-activities
plan: 01
type: execute
---

<objective>
Implement the Puzzle Matching activity - a dual-grid color pattern matching game.

Purpose: First playable activity where children match a target color pattern (ZIEL) by tapping colors and filling their grid (DU).
Output: PuzzleMatchingView with dual grids, color picker, pattern validation, success feedback, and level progression.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-screens/02-01-SUMMARY.md
@.planning/phases/02-core-screens/02-03-SUMMARY.md

**Key files:**
@BennieGame/BennieGame/Core/State/GameState.swift
@BennieGame/BennieGame/App/AppCoordinator.swift
@BennieGame/BennieGame/App/ContentView.swift
@BennieGame/BennieGame/Features/Activities/Raetsel/RaetselSelectionView.swift
@BennieGame/BennieGame/Design/Components/WoodButton.swift
@BennieGame/BennieGame/Design/Theme/Colors.swift

**Tech available:** SwiftUI, @Observable pattern, BennieColors palette, WoodButton/WoodSign components
**Established patterns:** Environment-based coordinator/playerStore, state-based routing in ContentView

**Game specifications (from FULL_ARCHIVE.md):**
- Dual grid display: ZIEL (target) on left, DU (player) on right
- Color picker at bottom with 2-4 colors (green, yellow, gray)
- Eraser and Reset buttons
- Grid cell touch target: 96×96pt minimum
- Grid progression: 3×3 (levels 1-10) → 4×4 (11-20) → 5×5 (21-30) → 6×6 (31+)
- Real-time comparison: when DU matches ZIEL → success
- +1 coin on success, check celebration trigger
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PuzzleMatchingView with dual grid layout</name>
  <files>BennieGame/BennieGame/Features/Activities/Raetsel/PuzzleMatchingView.swift</files>
  <action>
Create PuzzleMatchingView with:
1. Navigation header: Home button (left, 96pt), ProgressBar (center), Volume toggle (right)
2. Dual grid display:
   - ZIEL (target) grid on left inside stone tablet background
   - Arrow indicator (➡️) in center
   - DU (player) grid on right inside stone tablet background
3. Grid cells: 96×96pt minimum touch targets, use BennieColors for fills
4. Color picker at bottom: horizontal row of color buttons (green #99BF8C, yellow #D9C27A, gray #C4A574)
5. Eraser button and Reset button next to color picker
6. Use @Observable for game state:
   - targetGrid: [[Color?]] - the pattern to match
   - playerGrid: [[Color?]] - player's current grid
   - selectedColor: Color? - currently selected color
   - gridSize: Int (3-6)
7. Background: BennieColors.cream
8. German labels: "ZIEL" and "DU" above each grid

Color mapping:
- Green: BennieColors.success (#99BF8C)
- Yellow: BennieColors.coinGold (#D9C27A)
- Gray: BennieColors.woodLight (#C4A574)
- Empty cell: white with subtle border

DO NOT add voice/audio triggers - those come in Phase 5.
  </action>
  <verify>xcodebuild -project BennieGame/BennieGame.xcodeproj -scheme BennieGame -destination 'platform=iOS Simulator,name=iPad Pro 13-inch (M4)' build 2>&1 | tail -20</verify>
  <done>PuzzleMatchingView renders with dual grids, color picker, all touch targets ≥96pt</done>
</task>

<task type="auto">
  <name>Task 2: Implement game logic and level generation</name>
  <files>BennieGame/BennieGame/Features/Activities/Raetsel/PuzzleMatchingView.swift</files>
  <action>
Add game logic to PuzzleMatchingView:

1. Level generation function:
```swift
func generateLevel(levelNumber: Int) {
    // Determine grid size based on level
    let size = gridSizeForLevel(levelNumber)
    // Determine colors available (2 at start, add gray at level 6)
    let colors = colorsForLevel(levelNumber)
    // Generate random target pattern with appropriate fill density
    // Fill density: levels 1-5: 2-4 cells, 6-10: 3-5, etc.
}
```

2. Grid size progression:
   - Levels 1-10: 3×3
   - Levels 11-20: 4×4
   - Levels 21-30: 5×5
   - Levels 31+: 6×6

3. Color progression:
   - Levels 1-5: 2 colors (green, yellow)
   - Levels 6+: 3 colors (add gray)

4. Cell tap handler:
   - If selectedColor is nil, do nothing
   - Set playerGrid[row][col] = selectedColor
   - Check if playerGrid matches targetGrid
   - If match: trigger success flow

5. Success flow:
   - Award coin via playerStore.awardCoin()
   - Check celebration trigger via coordinator.shouldShowCelebration()
   - If celebration: coordinator.showCelebration()
   - Else: generate next level OR navigate home

6. Eraser: sets selectedColor to nil, tapping cell clears it
7. Reset: clears entire playerGrid to empty

Track current level number in view state, start at 1.
  </action>
  <verify>xcodebuild -project BennieGame/BennieGame.xcodeproj -scheme BennieGame -destination 'platform=iOS Simulator,name=iPad Pro 13-inch (M4)' build 2>&1 | tail -20</verify>
  <done>Game generates levels, player can fill grid, pattern matching works, success awards coin</done>
</task>

<task type="auto">
  <name>Task 3: Wire up navigation and ContentView routing</name>
  <files>BennieGame/BennieGame/Features/Activities/Raetsel/RaetselSelectionView.swift, BennieGame/BennieGame/App/ContentView.swift</files>
  <action>
1. Update RaetselSelectionView:
   - Make "Puzzle" button functional (remove comingSoon: true)
   - On tap: coordinator.startPlaying(.raetsel, .puzzleMatching)
   - Keep "Labyrinth" as comingSoon for now (will be implemented in 03-02)

2. Update ContentView:
   - In viewForState(.playing), check for .puzzleMatching subActivity
   - Route to PuzzleMatchingView instead of PlayingPlaceholder

```swift
case .playing(let activityType, let subActivity):
    switch subActivity {
    case .puzzleMatching:
        PuzzleMatchingView()
    default:
        PlayingPlaceholder(activityType: activityType, subActivity: subActivity)
    }
```

3. Add PuzzleMatchingView to Xcode project if not auto-added

4. Ensure back/home navigation works from PuzzleMatchingView
  </action>
  <verify>xcodebuild -project BennieGame/BennieGame.xcodeproj -scheme BennieGame -destination 'platform=iOS Simulator,name=iPad Pro 13-inch (M4)' build 2>&1 | tail -20</verify>
  <done>Can navigate Home → Rätsel → Puzzle, play activity, earn coin, return home</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `xcodebuild build` succeeds without errors
- [ ] PuzzleMatchingView displays dual grids with ZIEL/DU labels
- [ ] Color picker has 3 colors (green, yellow, gray)
- [ ] All touch targets ≥ 96pt (grid cells, buttons)
- [ ] Can fill player grid by selecting color then tapping cells
- [ ] Pattern validation detects when grids match
- [ ] Success awards +1 coin to current player
- [ ] Celebration triggers at 5-coin intervals
- [ ] Navigation: Home → Rätsel Selection → Puzzle → (play) → Home
- [ ] All text is German
- [ ] Colors from BennieColors only
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No build errors
- Puzzle Matching is fully playable with level progression
- Coin economy works (award on success, celebration on milestone)
</success_criteria>

<output>
After completion, create `.planning/phases/03-activities/03-01-SUMMARY.md`:

# 03-01 Summary: Puzzle Matching Activity

**[One-liner: what shipped]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- [List with descriptions]

## Commits
- [List of commits]

## Verification
- [Checklist results]

## Notes
- [Any deviations or decisions]

## Next Step
Ready for 03-02-PLAN.md (Labyrinth)
</output>
