---
phase: 03-activities
plan: 02
type: execute
---

<objective>
Implement the Labyrinth activity - a path-tracing maze game.

Purpose: Second Rätsel activity where children trace a path from START to ZIEL by dragging their finger along stone paths.
Output: LabyrinthView with maze rendering, touch tracking, path validation, and success feedback.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-activities/03-01-SUMMARY.md

**Key files:**
@BennieGame/BennieGame/Core/State/GameState.swift
@BennieGame/BennieGame/App/AppCoordinator.swift
@BennieGame/BennieGame/App/ContentView.swift
@BennieGame/BennieGame/Features/Activities/Raetsel/RaetselSelectionView.swift
@BennieGame/BennieGame/Features/Activities/Raetsel/PuzzleMatchingView.swift

**Tech available:** SwiftUI, @Observable, BennieColors, gesture recognizers
**Established patterns:** Environment coordinator/playerStore, activity view structure from PuzzleMatchingView

**Game specifications (from FULL_ARCHIVE.md):**
- Path tracing from START to ZIEL markers
- Stone path texture, 44pt path width (touch tolerance)
- Touch START to begin, drag along path
- If finger leaves path: show error, allow retry
- Reach ZIEL: success, +1 coin
- Visual: Bennie pointing at START, Lemminge at START (scared) and ZIEL (celebrating)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LabyrinthView with maze layout</name>
  <files>BennieGame/BennieGame/Features/Activities/Raetsel/LabyrinthView.swift</files>
  <action>
Create LabyrinthView with:

1. Navigation header: Home button, ProgressBar, Volume toggle (same as PuzzleMatchingView)

2. Maze container (center of screen):
   - Background: stone/forest themed
   - Path rendered as rounded thick lines (44pt width)
   - Path color: BennieColors.woodLight (#C4A574) for stone appearance
   - START marker: green circle with "START" label (top-left area)
   - ZIEL marker: gold circle with "ZIEL" label (bottom-right area)

3. Path structure (use simple path for MVP):
   - Pre-defined path points as [CGPoint] array
   - Path goes from START to ZIEL with some curves/turns
   - Use Path/Shape to draw the maze path

4. Visual elements (placeholder for now):
   - Bennie placeholder on left (pointing)
   - Lemminge placeholder near START and ZIEL

5. Game state:
   - isTracing: Bool - whether finger is currently drawing
   - currentPath: [CGPoint] - points traced by player
   - hasStarted: Bool - whether player touched START
   - hasCompleted: Bool - whether reached ZIEL
   - showError: Bool - if player went off path

6. Background: BennieColors.cream
7. German text for START/ZIEL labels

Path rendering approach:
- Draw maze path as thick stroked Path
- Overlay player's traced path in highlight color (BennieColors.success)
  </action>
  <verify>xcodebuild -project BennieGame/BennieGame.xcodeproj -scheme BennieGame -destination 'platform=iOS Simulator,name=iPad Pro 13-inch (M4)' build 2>&1 | tail -20</verify>
  <done>LabyrinthView renders with maze path, START/ZIEL markers visible</done>
</task>

<task type="auto">
  <name>Task 2: Implement touch tracking and path validation</name>
  <files>BennieGame/BennieGame/Features/Activities/Raetsel/LabyrinthView.swift</files>
  <action>
Add touch handling and path validation:

1. Use DragGesture for path tracing:
```swift
.gesture(
    DragGesture(minimumDistance: 0)
        .onChanged { value in
            handleDrag(at: value.location)
        }
        .onEnded { _ in
            handleDragEnd()
        }
)
```

2. handleDrag logic:
   - If !hasStarted: check if touch is near START (within 44pt)
     - If yes: set hasStarted = true, isTracing = true
   - If isTracing:
     - Check if current point is on valid path (within 44pt of any path point)
     - If on path: add to currentPath, continue
     - If off path: set showError = true, allow retry
     - Check if near ZIEL: if yes, trigger success

3. Path validation function:
```swift
func isOnValidPath(_ point: CGPoint) -> Bool {
    // Check distance to nearest point on the valid path
    // Path width tolerance: 44pt
    for pathPoint in validPathPoints {
        if distance(point, pathPoint) <= 44 {
            return true
        }
    }
    return false
}
```

4. Success flow (same pattern as PuzzleMatching):
   - Award coin via playerStore.awardCoin()
   - Check celebration
   - Generate next maze or navigate home

5. Error handling:
   - On off-path: show brief error indicator
   - Reset currentPath, allow player to restart from last valid point
   - Gentle feedback (no "wrong" text - just visual indicator)

6. Draw player progress as highlighted overlay on the path
  </action>
  <verify>xcodebuild -project BennieGame/BennieGame.xcodeproj -scheme BennieGame -destination 'platform=iOS Simulator,name=iPad Pro 13-inch (M4)' build 2>&1 | tail -20</verify>
  <done>Touch tracking works, path validation detects on/off path, success triggers on reaching ZIEL</done>
</task>

<task type="auto">
  <name>Task 3: Wire up navigation and level generation</name>
  <files>BennieGame/BennieGame/Features/Activities/Raetsel/RaetselSelectionView.swift, BennieGame/BennieGame/App/ContentView.swift, BennieGame/BennieGame/Features/Activities/Raetsel/LabyrinthView.swift</files>
  <action>
1. Update RaetselSelectionView:
   - Make "Labyrinth" button functional (remove comingSoon: true)
   - On tap: coordinator.startPlaying(.raetsel, .labyrinth)

2. Update ContentView routing:
```swift
case .playing(let activityType, let subActivity):
    switch subActivity {
    case .puzzleMatching:
        PuzzleMatchingView()
    case .labyrinth:
        LabyrinthView()
    default:
        PlayingPlaceholder(...)
    }
```

3. Add simple level variety to LabyrinthView:
   - Create 3-4 different maze path configurations
   - currentLevel: Int tracks which maze
   - On success: advance to next maze configuration
   - After all mazes: cycle back or return home

4. Maze path configurations (simple variations):
   - Maze 1: S-curve path
   - Maze 2: Zigzag path
   - Maze 3: L-shaped path with curves
   - Store as static arrays of CGPoint

5. Ensure home navigation works from LabyrinthView
  </action>
  <verify>xcodebuild -project BennieGame/BennieGame.xcodeproj -scheme BennieGame -destination 'platform=iOS Simulator,name=iPad Pro 13-inch (M4)' build 2>&1 | tail -20</verify>
  <done>Can navigate to Labyrinth, play multiple mazes, earn coins, return home</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `xcodebuild build` succeeds without errors
- [ ] LabyrinthView displays maze path with START/ZIEL markers
- [ ] Touch START initiates tracing
- [ ] Drag along path highlights progress
- [ ] Going off-path shows error (no harsh "wrong" message)
- [ ] Reaching ZIEL triggers success and +1 coin
- [ ] Multiple maze configurations work
- [ ] Celebration triggers at 5-coin intervals
- [ ] Navigation: Home → Rätsel → Labyrinth → (play) → Home
- [ ] All text is German
- [ ] Path width provides 44pt touch tolerance
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No build errors
- Labyrinth is fully playable
- Both Rätsel sub-activities (Puzzle + Labyrinth) now functional
</success_criteria>

<output>
After completion, create `.planning/phases/03-activities/03-02-SUMMARY.md`:

# 03-02 Summary: Labyrinth Activity

**[One-liner: what shipped]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- [List with descriptions]

## Commits
- [List of commits]

## Verification
- [Checklist results]

## Notes
- [Any deviations or decisions]

## Next Step
Ready for 03-03-PLAN.md (Würfel/Dice)
</output>
