---
phase: 04-reward-system
plan: 03
type: execute
---

<objective>
Implement treasure screen with YouTube redemption and video player with countdown timer.

Purpose: Complete the reward loop - coins → treasure → YouTube time - the core motivator for the app.
Output: Working TreasureView with redemption buttons, VideoSelectionView with approved videos, VideoPlayerView with WKWebView YouTube embed and countdown clock.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-reward-system/04-02-SUMMARY.md

**Key files:**
@BennieGame/BennieGame/App/ContentView.swift (TreasurePlaceholder, VideoSelectionPlaceholder, VideoPlayingPlaceholder)
@BennieGame/BennieGame/Features/Treasure/TreasureView.swift (already exists, may need enhancement)
@BennieGame/BennieGame/Core/State/PlayerStore.swift (spendCoins method exists)

**Tech stack available:**
- SwiftUI with @Observable pattern
- WebKit (WKWebView) for YouTube embedding
- BennieColors, BennieFont design system
- Timer for countdown

**YouTube embed requirements (from research):**
- Use youtube-nocookie.com domain for privacy
- URL format: https://www.youtube-nocookie.com/embed/{VIDEO_ID}
- Parameters: controls=0 (hide), rel=0 (no related), modestbranding=1, playsinline=1
- Disable keyboard: disablekb=1
- autoplay=1 to start immediately
- WKWebView configuration: allowsInlineMediaPlayback = true

**Reward tiers:**
- Tier 1: 10 coins → 5 minutes YouTube
- Tier 2: 20 coins → 12 minutes YouTube (includes 2 min bonus)

**Default approved videos (hardcoded for MVP):**
- Peppa Pig German episodes (popular with target age)
- Use 3-4 known German kids' video IDs

**Constraining decisions:**
- German only UI
- Analog clock countdown (design spec)
- 1-minute warning before time up
- Auto-return to home when time expires
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create full TreasureView implementation</name>
  <files>BennieGame/BennieGame/Features/Treasure/TreasureView.swift</files>
  <action>
Replace the existing TreasureView (currently minimal) with full implementation:
- Navigation header with home button and coin display
- Large treasure chest image/icon in center (use SF Symbol "shippingbox.fill" styled as chest, or create with shapes)
- "Schatztruhe" title using WoodSign component
- Two redemption buttons using WoodButton:
  - "5 Min YouTube" (10 Münzen) - enabled when coins >= 10
  - "12 Min YouTube" (20 Münzen) - enabled when coins >= 20
- Disabled buttons show chains/lock visual (use .opacity(0.5) and chain emoji or lock icon)
- Current coin count prominently displayed
- When button tapped:
  1. Call playerStore.spendCoins(amount)
  2. Store selected minutes in coordinator or pass to next screen
  3. Navigate to videoSelection

Layout:
- Back button top-left
- Coin display top-center
- Chest centered
- Buttons below chest, stacked vertically
- Use BennieColors.cream background

Do NOT show Bennie/Lemminge characters yet (Phase 5 audio will add them).
  </action>
  <verify>xcodebuild build succeeds, TreasureView shows both buttons with correct enabled/disabled states based on coins</verify>
  <done>TreasureView shows redemption buttons, spends coins correctly, navigates to video selection</done>
</task>

<task type="auto">
  <name>Task 2: Create VideoSelectionView with hardcoded approved videos</name>
  <files>BennieGame/BennieGame/Features/Video/VideoSelectionView.swift, BennieGame.xcodeproj/project.pbxproj</files>
  <action>
Create VideoSelectionView.swift in Features/Video/:
- Title: "Wähle ein Video!" using WoodSign
- Grid of video thumbnail buttons (2-3 columns)
- Hardcode 4-6 approved videos for MVP:
  ```swift
  struct ApprovedVideo: Identifiable {
      let id: String  // YouTube video ID
      let title: String
      let thumbnailURL: URL  // https://img.youtube.com/vi/{ID}/mqdefault.jpg
  }

  static let approvedVideos: [ApprovedVideo] = [
      ApprovedVideo(id: "dQw4w9WgXcQ", title: "Peppa Wutz Deutsch", thumbnailURL: ...),
      // Add 3-5 more kid-appropriate German videos
  ]
  ```
- Each video button shows:
  - Thumbnail image (AsyncImage with placeholder)
  - Title below (max 2 lines)
- On tap: Store selected video ID, navigate to .videoPlaying(minutesRemaining: X)
- Back button to return to treasure
- Show allocated time at bottom: "Du hast X Minuten Zeit!"

Store the selected video ID somewhere accessible to VideoPlayerView:
- Option A: Add to GameState enum: .videoPlaying(minutes: Int, videoId: String)
- Option B: Store in a shared service/coordinator property

Add to Xcode project.pbxproj.
  </action>
  <verify>xcodebuild build succeeds, VideoSelectionView shows grid of video thumbnails, tapping navigates to video player</verify>
  <done>VideoSelectionView displays approved videos with thumbnails, selection works, time allocation shown</done>
</task>

<task type="auto">
  <name>Task 3: Create VideoPlayerView with WKWebView and countdown</name>
  <files>BennieGame/BennieGame/Features/Video/VideoPlayerView.swift, BennieGame.xcodeproj/project.pbxproj</files>
  <action>
Create VideoPlayerView.swift with embedded YouTube and countdown:

**YouTube WKWebView embed:**
```swift
import WebKit

struct YouTubePlayerView: UIViewRepresentable {
    let videoId: String

    func makeUIView(context: Context) -> WKWebView {
        let config = WKWebViewConfiguration()
        config.allowsInlineMediaPlayback = true
        config.mediaTypesRequiringUserActionForPlayback = []

        let webView = WKWebView(frame: .zero, configuration: config)
        webView.scrollView.isScrollEnabled = false
        return webView
    }

    func updateUIView(_ webView: WKWebView, context: Context) {
        let embedURL = "https://www.youtube-nocookie.com/embed/\(videoId)?controls=0&rel=0&modestbranding=1&playsinline=1&autoplay=1&disablekb=1"
        if let url = URL(string: embedURL) {
            webView.load(URLRequest(url: url))
        }
    }
}
```

**VideoPlayerView layout:**
- YouTube player takes top 70% of screen
- Bottom 30%: countdown display area
- Analog clock countdown (circle with arc that depletes):
  - Use Circle with trim(from:to:) animated based on remaining time
  - BennieColors.success for remaining time arc
  - BennieColors.woodLight for depleted time
- Digital time remaining below clock: "X:XX" format
- NO visible controls or buttons (time-based exit only)

**Countdown logic:**
- @State var secondsRemaining: Int (initialized from minutesRemaining * 60)
- Timer.publish every 1 second
- At 60 seconds remaining: Show visual pulse on clock (1-minute warning)
- At 0 seconds:
  1. Stop video (webView.stopLoading() via coordination)
  2. Show brief "Zeit ist um!" message
  3. After 2 seconds, navigate home

Add to Xcode project.pbxproj.
  </action>
  <verify>xcodebuild build succeeds, VideoPlayerView embeds YouTube, countdown works, auto-exits when time up</verify>
  <done>VideoPlayerView plays YouTube video, countdown depletes visually, 1-min warning pulses, auto-returns home at 0</done>
</task>

<task type="auto">
  <name>Task 4: Wire video views into ContentView and update GameState</name>
  <files>BennieGame/BennieGame/App/ContentView.swift, BennieGame/BennieGame/Core/State/GameState.swift, BennieGame/BennieGame/App/AppCoordinator.swift</files>
  <action>
Update routing to use new views:

**GameState.swift:**
Update videoPlaying case to include video ID:
```swift
case videoPlaying(minutesRemaining: Int, videoId: String)
```

**AppCoordinator.swift:**
Update startVideoPlayback to accept videoId:
```swift
func startVideoPlayback(minutes: Int, videoId: String) {
    transition(to: .videoPlaying(minutesRemaining: minutes, videoId: videoId))
}
```

Also add property to store allocated minutes for video selection:
```swift
var allocatedVideoMinutes: Int = 0
```

**ContentView.swift:**
1. Replace TreasurePlaceholder routing with TreasureView (already exists, just verify routing)
2. Replace VideoSelectionPlaceholder with VideoSelectionView:
   ```swift
   case .videoSelection:
       VideoSelectionView()
   ```
3. Replace VideoPlayingPlaceholder with VideoPlayerView:
   ```swift
   case .videoPlaying(let minutes, let videoId):
       VideoPlayerView(minutesRemaining: minutes, videoId: videoId)
   ```
4. Delete the placeholder structs that are no longer needed

Update Equatable conformance for GameState if needed (videoId is String, should work).
  </action>
  <verify>xcodebuild build succeeds, full flow works: Treasure → Video Selection → Video Playing → auto-return Home</verify>
  <done>Full video redemption flow works end-to-end, placeholders removed, GameState updated</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] xcodebuild build succeeds without errors
- [ ] TreasureView: redemption buttons work, coins deduct correctly
- [ ] VideoSelectionView: shows video grid, thumbnails load
- [ ] VideoPlayerView: YouTube embeds and plays
- [ ] Countdown: visual clock depletes, 1-min warning visible
- [ ] Auto-exit: returns home when time reaches 0
- [ ] Full flow: Earn 10 coins → Treasure → Select video → Watch → Time up → Home
- [ ] German UI throughout
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- YouTube plays without visible controls
- Countdown feels predictable and clear for children
- No way to extend time or bypass countdown
- Coins properly deducted on redemption
- Phase 4 complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-reward-system/04-03-SUMMARY.md` with:
- Summary of treasure and video implementation
- Files created/modified
- YouTube embed approach used
- Any issues with WKWebView or countdown
- Verification of full reward loop
- Phase 4 completion status
</output>
