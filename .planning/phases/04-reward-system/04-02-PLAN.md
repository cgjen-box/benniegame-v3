---
phase: 04-reward-system
plan: 02
type: execute
---

<objective>
Implement the celebration overlay with confetti animation, character reactions, and milestone messages.

Purpose: Create joyful milestone moments that reinforce positive behavior at every 5-coin interval.
Output: Full celebration overlay replacing the placeholder, with confetti, Bennie celebrating, and milestone-specific messages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-reward-system/04-01-SUMMARY.md

**Key files:**
@BennieGame/BennieGame/App/ContentView.swift (CelebrationPlaceholder at lines 225-253)
@BennieGame/BennieGame/App/AppCoordinator.swift
@BennieGame/BennieGame/Core/State/PlayerStore.swift

**Tech stack available:**
- SwiftUI with @Observable pattern
- Lottie for animations (imported via SPM)
- BennieColors design system (coinGold, success, cream)
- BennieFont typography system

**Design spec from PLAYBOOK_CONDENSED.md:**
- OVERLAY design (transparent, activity screen visible but dimmed to 40%)
- "Super gemacht!" primary message
- "+1" coin animation
- Confetti animation (full screen)
- "Weiter →" button to continue

**Milestone messages (German):**
- 5 coins: "Wir haben schon fünf Goldmünzen!"
- 10 coins: "Zehn Goldmünzen! Du kannst jetzt YouTube schauen."
- 15 coins: "Fünfzehn! Weiter so!"
- 20 coins: "Zwanzig Münzen! Du bekommst Bonuszeit!"

**Constraining decisions:**
- Celebration triggers at coins % 5 == 0 (existing logic)
- If coins >= 10, show "Zur Schatztruhe" button
- German only, positive only
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CelebrationOverlay view component</name>
  <files>BennieGame/BennieGame/Features/Celebration/CelebrationOverlay.swift, BennieGame.xcodeproj/project.pbxproj</files>
  <action>
Create CelebrationOverlay.swift to replace CelebrationPlaceholder:
- Semi-transparent overlay (background Color.black.opacity(0.4))
- Center content card with BennieColors.cream background, rounded corners
- "Super gemacht!" title using BennieFont.title() in BennieColors.coinGold
- Large coin count display using BennieFont.number(72)
- Milestone-specific message based on coinsEarned (5, 10, 15, 20+)
- "Weiter →" button (WoodButton) - navigates home or to next activity
- "Zur Schatztruhe!" button (WoodButton, golden) - visible only when coins >= 10
- Use @Environment(AppCoordinator.self) and @Environment(PlayerStore.self)

Milestone message logic:
```swift
var milestoneMessage: String {
    switch coinsEarned {
    case 5: return "Wir haben schon fünf Goldmünzen!"
    case 10: return "Zehn Goldmünzen! Du kannst jetzt YouTube schauen."
    case 15: return "Fünfzehn! Weiter so!"
    case 20: return "Zwanzig Münzen! Du bekommst Bonuszeit!"
    default: return "Super gemacht!"
    }
}
```

Add to Xcode project.pbxproj using established pattern.
  </action>
  <verify>xcodebuild build succeeds, CelebrationOverlay preview shows overlay with correct layout</verify>
  <done>CelebrationOverlay renders with milestone messages, treasure button conditional on >= 10 coins</done>
</task>

<task type="auto">
  <name>Task 2: Add confetti animation to celebration</name>
  <files>BennieGame/BennieGame/Features/Celebration/CelebrationOverlay.swift</files>
  <action>
Add confetti particle animation to CelebrationOverlay:
- Create ConfettiView as a private struct within the file
- Use Canvas or multiple animated views to show falling confetti particles
- Colors: BennieColors.coinGold, BennieColors.success, BennieColors.woodLight
- Particle shapes: small circles and rectangles
- Animation: particles fall from top with slight horizontal drift
- Duration: continuous while overlay is visible
- Performance: limit to ~50 particles, reuse as they fall off screen

Alternatively, use a simple approach with ForEach over particle array:
- @State var particles: [ConfettiParticle] with position, color, rotation
- Timer to update positions
- Each particle: small colored circle or rectangle

Add confetti as background layer of the overlay (behind content card).
Do NOT use external Lottie files for confetti - keep it pure SwiftUI for simplicity.
  </action>
  <verify>xcodebuild build succeeds, celebration shows colorful falling confetti animation</verify>
  <done>Confetti particles fall continuously during celebration, colors match palette, performance stays at 60fps</done>
</task>

<task type="auto">
  <name>Task 3: Wire CelebrationOverlay into ContentView routing</name>
  <files>BennieGame/BennieGame/App/ContentView.swift</files>
  <action>
Replace CelebrationPlaceholder with CelebrationOverlay in ContentView routing:
- Import or reference CelebrationOverlay (it's in Features/Celebration/)
- In viewForState switch, change:
  ```swift
  case .celebrationOverlay(let coinsEarned):
      CelebrationPlaceholder(coinsEarned: coinsEarned)
  ```
  to:
  ```swift
  case .celebrationOverlay(let coinsEarned):
      CelebrationOverlay(coinsEarned: coinsEarned)
  ```
- Delete the CelebrationPlaceholder struct (it's private, at lines 225-253)
- Ensure CelebrationOverlay receives coinsEarned parameter

Test the flow: Activity → correct answer → coin fly → celebration overlay → button tap → continues
  </action>
  <verify>xcodebuild build succeeds, earning 5 coins in any activity triggers CelebrationOverlay instead of placeholder</verify>
  <done>CelebrationOverlay replaces placeholder, shows on every 5-coin milestone, navigation buttons work correctly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] xcodebuild build succeeds without errors
- [ ] CelebrationOverlay created in Features/Celebration/
- [ ] Confetti animation renders smoothly
- [ ] Milestone messages correct for 5, 10, 15, 20 coins
- [ ] "Zur Schatztruhe" button only shows when coins >= 10
- [ ] Navigation: "Weiter" returns to activity/home, "Schatztruhe" goes to treasure
- [ ] CelebrationPlaceholder removed from ContentView
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Celebration feels joyful and rewarding
- German messages display correctly
- Touch targets >= 96pt on buttons
- No "Falsch" or negative language
</success_criteria>

<output>
After completion, create `.planning/phases/04-reward-system/04-02-SUMMARY.md` with:
- Summary of celebration implementation
- Files created/modified
- Confetti approach used
- Verification that milestone messages work correctly
</output>
