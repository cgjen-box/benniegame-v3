---
phase: 05-audio-integration
plan: 03
type: execute
---

<objective>
Wire audio triggers throughout the app - activities, celebration, treasure, video player, and mute toggle.

Purpose: Connect all audio services to actual user interactions, completing the audio integration.
Output: Audio plays at all trigger points (activities, celebrations, treasure, video), mute toggle functional.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior work:**
@.planning/phases/05-audio-integration/05-01-SUMMARY.md
@.planning/phases/05-audio-integration/05-02-SUMMARY.md

**Key files to modify:**
@BennieGame/BennieGame/App/BennieGameApp.swift (inject services)
@BennieGame/BennieGame/Features/Loading/LoadingView.swift
@BennieGame/BennieGame/Features/PlayerSelection/PlayerSelectionView.swift
@BennieGame/BennieGame/Features/Home/HomeView.swift
@BennieGame/BennieGame/Features/Activities/Raetsel/PuzzleMatchingView.swift
@BennieGame/BennieGame/Features/Activities/Raetsel/LabyrinthView.swift
@BennieGame/BennieGame/Features/Activities/Zahlen/WuerfelView.swift
@BennieGame/BennieGame/Features/Activities/Zahlen/WaehleZahlView.swift
@BennieGame/BennieGame/Features/Celebration/CelebrationOverlay.swift
@BennieGame/BennieGame/Features/Treasure/TreasureView.swift
@BennieGame/BennieGame/Features/Video/VideoPlayerView.swift

**Audio trigger points (from PLAYBOOK):**
- Loading 100%: narrator "ready to play"
- Player selection: narrator question, hello on selection
- Home first visit: narrator question, Bennie greeting
- Activity start: narrator instruction, Bennie encouragement
- Correct answer: success chime, random success phrase
- Wrong answer: gentle boop, Bennie hint
- Coin earned: coin collect sound
- Celebration: fanfare, Bennie celebration voice
- Treasure entry: Bennie treasure message
- Video 1-min: Bennie warning
- Video end: Bennie time up
- All buttons: tap wood sound
</context>

<tasks>

<task type="auto">
  <name>Task 1: Inject audio services into app environment and add mute toggle</name>
  <files>BennieGame/BennieGame/App/BennieGameApp.swift, BennieGame/BennieGame/Design/Components/MuteButton.swift</files>
  <action>
1. Update BennieGameApp.swift to create and inject all audio services:

```swift
@main
struct BennieGameApp: App {
    @State private var coordinator = AppCoordinator()
    @State private var playerStore = PlayerStore()
    @State private var audioManager = AudioManager()

    // Voice services depend on AudioManager
    private var narratorService: NarratorService { NarratorService(audioManager: audioManager) }
    private var bennieService: BennieService { BennieService(audioManager: audioManager) }

    var body: some Scene {
        WindowGroup {
            ContentView()
                .environment(coordinator)
                .environment(playerStore)
                .environment(audioManager)
                .environment(narratorService)
                .environment(bennieService)
        }
    }
}
```

2. Create MuteButton.swift component:

```swift
import SwiftUI

struct MuteButton: View {
    @Environment(AudioManager.self) private var audioManager

    var body: some View {
        Button {
            audioManager.toggleMute()
        } label: {
            Image(systemName: audioManager.isMuted ? "speaker.slash.fill" : "speaker.wave.2.fill")
                .font(.system(size: 28))
                .foregroundColor(BennieColors.woodDark)
                .frame(width: 96, height: 96)
                .background(
                    Circle()
                        .fill(BennieColors.woodLight)
                        .overlay(Circle().stroke(BennieColors.woodDark, lineWidth: 2))
                )
        }
        .buttonStyle(.plain)
    }
}
```

Add MuteButton to Xcode project.
  </action>
  <verify>xcodebuild build succeeds, all services injected, MuteButton renders</verify>
  <done>Audio services in environment, MuteButton component created</done>
</task>

<task type="auto">
  <name>Task 2: Wire audio triggers to activities and success flow</name>
  <files>BennieGame/BennieGame/Features/Activities/Raetsel/PuzzleMatchingView.swift, BennieGame/BennieGame/Features/Activities/Raetsel/LabyrinthView.swift, BennieGame/BennieGame/Features/Activities/Zahlen/WuerfelView.swift, BennieGame/BennieGame/Features/Activities/Zahlen/WaehleZahlView.swift</files>
  <action>
Add audio triggers to each activity view. Pattern for each:

1. Add environment properties:
```swift
@Environment(AudioManager.self) private var audioManager
@Environment(NarratorService.self) private var narrator
@Environment(BennieService.self) private var bennie
```

2. Add onAppear audio triggers for activity start:
```swift
.onAppear {
    narrator.playPuzzleStart()  // or appropriate activity start
    bennie.playPuzzleStart()
}
```

3. Add audio to success handling (after correct answer):
```swift
func handleSuccess() {
    audioManager.playEffect(.successChime)
    audioManager.playEffect(.coinCollect)
    narrator.playRandomSuccess()
    // ... existing coin award logic
}
```

4. Add audio to wrong answer handling (gentle, not negative):
```swift
func handleWrongAnswer() {
    audioManager.playEffect(.gentleBoop)
    // For dice/numbers: bennie.playWrongNumber()
    // For labyrinth: bennie.playLabyrinthWrong()
}
```

For WuerfelView specifically, add number narration:
```swift
func rollDice() {
    let result = Int.random(in: 1...6)
    // ... animation
    narrator.playShowNumber(result)
}
```

For WaehleZahlView specifically:
```swift
func selectNewTarget() {
    let target = Int.random(in: 1...10)
    narrator.playChooseNumber(target)
}
```

Replace placeholder volume buttons in navigation headers with MuteButton().
  </action>
  <verify>xcodebuild build succeeds, activities have audio environment, trigger methods called</verify>
  <done>All 4 activities wired with audio triggers for start, success, wrong answer</done>
</task>

<task type="auto">
  <name>Task 3: Wire audio to celebration, treasure, and video screens</name>
  <files>BennieGame/BennieGame/Features/Celebration/CelebrationOverlay.swift, BennieGame/BennieGame/Features/Treasure/TreasureView.swift, BennieGame/BennieGame/Features/Video/VideoPlayerView.swift, BennieGame/BennieGame/Features/Loading/LoadingView.swift, BennieGame/BennieGame/Features/PlayerSelection/PlayerSelectionView.swift, BennieGame/BennieGame/Features/Home/HomeView.swift</files>
  <action>
Wire audio to remaining screens:

**LoadingView.swift:**
```swift
@Environment(NarratorService.self) private var narrator

// When progress reaches 100%:
.onChange(of: loadingProgress) { _, newValue in
    if newValue >= 1.0 {
        narrator.playLoadingComplete()
    }
}
```

**PlayerSelectionView.swift:**
```swift
@Environment(NarratorService.self) private var narrator

.onAppear {
    narrator.playPlayerQuestion()
}

// On player button tap:
func selectPlayer(_ player: PlayerData) {
    narrator.playHello(playerName: player.name)
    // ... existing selection logic
}
```

**HomeView.swift:**
```swift
@Environment(NarratorService.self) private var narrator
@Environment(BennieService.self) private var bennie

.onAppear {
    narrator.playHomeQuestion()
    // First visit greeting:
    if isFirstVisit {
        bennie.playGreetingPart1(playerName: playerStore.activePlayer?.name ?? "")
        // After delay:
        DispatchQueue.main.asyncAfter(deadline: .now() + 2) {
            bennie.playGreetingPart2()
        }
    }
}

// Locked activity tap:
func handleLockedActivity() {
    bennie.playLocked()
}
```

**CelebrationOverlay.swift:**
```swift
@Environment(AudioManager.self) private var audioManager
@Environment(BennieService.self) private var bennie

.onAppear {
    audioManager.playEffect(.celebrationFanfare)
    bennie.playCelebration(coins: coinsEarned)
}
```

**TreasureView.swift:**
```swift
@Environment(AudioManager.self) private var audioManager
@Environment(BennieService.self) private var bennie

.onAppear {
    audioManager.playEffect(.chestOpen)
    bennie.playTreasureMessage(coins: playerStore.activePlayerCoins)
}
```

**VideoPlayerView.swift:**
```swift
@Environment(BennieService.self) private var bennie

// At 60 seconds remaining:
if secondsRemaining == 60 {
    bennie.playOneMinuteWarning()
}

// At 0 seconds:
if secondsRemaining == 0 {
    bennie.playTimeUp()
}
```

Replace all placeholder volume toggle buttons with MuteButton().
  </action>
  <verify>xcodebuild build succeeds, all screens have audio triggers, mute buttons work</verify>
  <done>All screens wired with audio triggers, Phase 5 complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] xcodebuild build succeeds without errors
- [ ] All audio services injected in environment
- [ ] MuteButton component works
- [ ] Activities play sounds on success/wrong
- [ ] Celebration plays fanfare
- [ ] Treasure plays chest sound
- [ ] Video player has time warnings
- [ ] Mute toggle affects all audio
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Audio triggers at all user interaction points
- Mute toggle works throughout app
- Graceful degradation (no crashes for missing files)
- Phase 5 complete
</success_criteria>

<output>
After completion, create `.planning/phases/05-audio-integration/05-03-SUMMARY.md` with:
- Screens modified with audio
- Trigger points implemented
- Mute functionality
- Any issues encountered
- Phase 5 completion status
</output>
