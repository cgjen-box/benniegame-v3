#!/bin/bash
# Pre-push hook - Secondary secret scan before pushing
# Install: cp hooks/pre-push .git/hooks/ && chmod +x .git/hooks/pre-push

echo "Running pre-push secret scan..."

# Run the check_secrets.py script if available
if [ -f "scripts/check_secrets.py" ]; then
    python scripts/check_secrets.py --staged-only
    if [ $? -ne 0 ]; then
        echo ""
        echo "=========================================="
        echo "PUSH BLOCKED: Secrets detected!"
        echo "=========================================="
        exit 1
    fi
fi

# Fallback: basic pattern check on recent commits
REMOTE="$1"
URL="$2"

z40=0000000000000000000000000000000000000000

while read local_ref local_sha remote_ref remote_sha
do
    if [ "$local_sha" = $z40 ]; then
        # Branch being deleted
        continue
    fi

    if [ "$remote_sha" = $z40 ]; then
        # New branch
        range="$local_sha"
    else
        # Update to existing branch
        range="$remote_sha..$local_sha"
    fi

    # Check for secrets in commit range
    SECRETS=$(git diff $range --name-only 2>/dev/null | xargs -I{} git show $local_sha:{} 2>/dev/null | grep -E 'sk_[a-zA-Z0-9]{20,}|AIza[0-9A-Za-z_-]{35}|AKIA[0-9A-Z]{16}')

    if [ -n "$SECRETS" ]; then
        echo "ERROR: Potential secrets found in commits being pushed"
        exit 1
    fi
done

echo "No secrets detected. Proceeding with push."
exit 0
