#!/bin/bash
# Pre-commit hook - Block commits containing secrets
# Install: cp hooks/pre-commit .git/hooks/ && chmod +x .git/hooks/pre-commit

echo "Running secret scan on staged files..."

# Patterns to detect
PATTERNS=(
    'sk_[a-zA-Z0-9]{20,}'                          # ElevenLabs
    'AIza[0-9A-Za-z_-]{35}'                        # Google/Gemini
    'sk-[a-zA-Z0-9]{20,}'                          # OpenAI
    'sk-ant-[a-zA-Z0-9_-]{20,}'                    # Anthropic
    'AKIA[0-9A-Z]{16}'                             # AWS
    'ghp_[0-9a-zA-Z]{36}'                          # GitHub
    'glpat-[0-9a-zA-Z_-]{20}'                      # GitLab
    'xox[baprs]-[0-9a-zA-Z-]{10,}'                 # Slack
    'sk_live_[0-9a-zA-Z]{24,}'                     # Stripe
    'SG\.[a-zA-Z0-9_-]{22}\.[a-zA-Z0-9_-]{43}'    # SendGrid
    'mongodb(\+srv)?://[^:]+:[^@]+@'              # MongoDB
    'postgres(ql)?://[^:]+:[^@]+@'                # PostgreSQL
    '-----BEGIN.*PRIVATE KEY-----'                 # Private keys
)

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

FOUND_SECRETS=0

for file in $STAGED_FILES; do
    # Skip binary files and certain extensions
    if [[ "$file" =~ \.(png|jpg|jpeg|gif|ico|woff|ttf|eot|pdf|zip)$ ]]; then
        continue
    fi

    # Skip .env.example (it's supposed to have placeholder patterns)
    if [[ "$file" == *".env.example"* ]]; then
        continue
    fi

    for pattern in "${PATTERNS[@]}"; do
        if git show ":$file" 2>/dev/null | grep -qE "$pattern"; then
            echo "ERROR: Potential secret found in $file"
            echo "Pattern: $pattern"
            FOUND_SECRETS=1
        fi
    done
done

if [ $FOUND_SECRETS -eq 1 ]; then
    echo ""
    echo "=========================================="
    echo "COMMIT BLOCKED: Secrets detected!"
    echo "=========================================="
    echo ""
    echo "Remove the secrets and use environment variables instead."
    echo "See secret_guard.py for secure secret access."
    echo ""
    exit 1
fi

echo "No secrets detected. Proceeding with commit."
exit 0
